<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Configuration | MassTransit</title>
    <meta name="description" content="A free, open-source distributed application framework for .NET.">
    
    
    <link rel="preload" href="/MassTransit/assets/css/0.styles.3c3540eb.css" as="style"><link rel="preload" href="/MassTransit/assets/js/app.35715e6f.js" as="script"><link rel="preload" href="/MassTransit/assets/js/2.d01194ec.js" as="script"><link rel="preload" href="/MassTransit/assets/js/72.4e7b6ada.js" as="script"><link rel="prefetch" href="/MassTransit/assets/js/10.4c8ec4ee.js"><link rel="prefetch" href="/MassTransit/assets/js/100.a4922aba.js"><link rel="prefetch" href="/MassTransit/assets/js/101.28301740.js"><link rel="prefetch" href="/MassTransit/assets/js/102.4da7841b.js"><link rel="prefetch" href="/MassTransit/assets/js/103.55327799.js"><link rel="prefetch" href="/MassTransit/assets/js/104.c327e2ce.js"><link rel="prefetch" href="/MassTransit/assets/js/105.03546a12.js"><link rel="prefetch" href="/MassTransit/assets/js/106.fca1c0dc.js"><link rel="prefetch" href="/MassTransit/assets/js/11.ae22c166.js"><link rel="prefetch" href="/MassTransit/assets/js/12.697658b9.js"><link rel="prefetch" href="/MassTransit/assets/js/13.7b86bb52.js"><link rel="prefetch" href="/MassTransit/assets/js/14.be5c99d8.js"><link rel="prefetch" href="/MassTransit/assets/js/15.d0f537bf.js"><link rel="prefetch" href="/MassTransit/assets/js/16.cbfcd2ad.js"><link rel="prefetch" href="/MassTransit/assets/js/17.0c1291de.js"><link rel="prefetch" href="/MassTransit/assets/js/18.3a0ff71b.js"><link rel="prefetch" href="/MassTransit/assets/js/19.5c3468d1.js"><link rel="prefetch" href="/MassTransit/assets/js/20.00f55e73.js"><link rel="prefetch" href="/MassTransit/assets/js/21.0e5ecf82.js"><link rel="prefetch" href="/MassTransit/assets/js/22.e77c30a0.js"><link rel="prefetch" href="/MassTransit/assets/js/23.2ccaddf7.js"><link rel="prefetch" href="/MassTransit/assets/js/24.e5122a93.js"><link rel="prefetch" href="/MassTransit/assets/js/25.ff9934c4.js"><link rel="prefetch" href="/MassTransit/assets/js/26.c96a8535.js"><link rel="prefetch" href="/MassTransit/assets/js/27.42f0b0e8.js"><link rel="prefetch" href="/MassTransit/assets/js/28.b139b450.js"><link rel="prefetch" href="/MassTransit/assets/js/29.44427ee4.js"><link rel="prefetch" href="/MassTransit/assets/js/3.0af1cfd3.js"><link rel="prefetch" href="/MassTransit/assets/js/30.a3c7546f.js"><link rel="prefetch" href="/MassTransit/assets/js/31.26d3b153.js"><link rel="prefetch" href="/MassTransit/assets/js/32.21c8d85c.js"><link rel="prefetch" href="/MassTransit/assets/js/33.60e822ec.js"><link rel="prefetch" href="/MassTransit/assets/js/34.83670677.js"><link rel="prefetch" href="/MassTransit/assets/js/35.7121ef0d.js"><link rel="prefetch" href="/MassTransit/assets/js/36.b3bdb7a7.js"><link rel="prefetch" href="/MassTransit/assets/js/37.fd50b8c6.js"><link rel="prefetch" href="/MassTransit/assets/js/38.ca1af769.js"><link rel="prefetch" href="/MassTransit/assets/js/39.8a01e6c2.js"><link rel="prefetch" href="/MassTransit/assets/js/4.59116900.js"><link rel="prefetch" href="/MassTransit/assets/js/40.d28c9f0a.js"><link rel="prefetch" href="/MassTransit/assets/js/41.98667d2f.js"><link rel="prefetch" href="/MassTransit/assets/js/42.f39f09a4.js"><link rel="prefetch" href="/MassTransit/assets/js/43.1e05245e.js"><link rel="prefetch" href="/MassTransit/assets/js/44.4e17f750.js"><link rel="prefetch" href="/MassTransit/assets/js/45.8d1d7271.js"><link rel="prefetch" href="/MassTransit/assets/js/46.b2dbac86.js"><link rel="prefetch" href="/MassTransit/assets/js/47.f1aa8bbb.js"><link rel="prefetch" href="/MassTransit/assets/js/48.44c78fa3.js"><link rel="prefetch" href="/MassTransit/assets/js/49.083d197d.js"><link rel="prefetch" href="/MassTransit/assets/js/5.1d3e2cf6.js"><link rel="prefetch" href="/MassTransit/assets/js/50.acdb5188.js"><link rel="prefetch" href="/MassTransit/assets/js/51.368b1bb1.js"><link rel="prefetch" href="/MassTransit/assets/js/52.a16ac88f.js"><link rel="prefetch" href="/MassTransit/assets/js/53.747838c5.js"><link rel="prefetch" href="/MassTransit/assets/js/54.88a4e8f0.js"><link rel="prefetch" href="/MassTransit/assets/js/55.1ed74524.js"><link rel="prefetch" href="/MassTransit/assets/js/56.d6be0941.js"><link rel="prefetch" href="/MassTransit/assets/js/57.ec053e4a.js"><link rel="prefetch" href="/MassTransit/assets/js/58.89897b01.js"><link rel="prefetch" href="/MassTransit/assets/js/59.b03c9a56.js"><link rel="prefetch" href="/MassTransit/assets/js/6.7d02cd3b.js"><link rel="prefetch" href="/MassTransit/assets/js/60.6f5c5a8e.js"><link rel="prefetch" href="/MassTransit/assets/js/61.22b788f0.js"><link rel="prefetch" href="/MassTransit/assets/js/62.7a46067b.js"><link rel="prefetch" href="/MassTransit/assets/js/63.fa629e14.js"><link rel="prefetch" href="/MassTransit/assets/js/64.461d2327.js"><link rel="prefetch" href="/MassTransit/assets/js/65.3be2b22c.js"><link rel="prefetch" href="/MassTransit/assets/js/66.088eaa99.js"><link rel="prefetch" href="/MassTransit/assets/js/67.aa4a0e42.js"><link rel="prefetch" href="/MassTransit/assets/js/68.2343f41a.js"><link rel="prefetch" href="/MassTransit/assets/js/69.5760c371.js"><link rel="prefetch" href="/MassTransit/assets/js/7.d34c132d.js"><link rel="prefetch" href="/MassTransit/assets/js/70.1b795a08.js"><link rel="prefetch" href="/MassTransit/assets/js/71.5f851dc4.js"><link rel="prefetch" href="/MassTransit/assets/js/73.0c270da4.js"><link rel="prefetch" href="/MassTransit/assets/js/74.ed350914.js"><link rel="prefetch" href="/MassTransit/assets/js/75.96bac087.js"><link rel="prefetch" href="/MassTransit/assets/js/76.8164340d.js"><link rel="prefetch" href="/MassTransit/assets/js/77.be02c6e3.js"><link rel="prefetch" href="/MassTransit/assets/js/78.1af2718f.js"><link rel="prefetch" href="/MassTransit/assets/js/79.4a5eab4b.js"><link rel="prefetch" href="/MassTransit/assets/js/8.3bb286ea.js"><link rel="prefetch" href="/MassTransit/assets/js/80.2f525084.js"><link rel="prefetch" href="/MassTransit/assets/js/81.20e04321.js"><link rel="prefetch" href="/MassTransit/assets/js/82.eb5a0b20.js"><link rel="prefetch" href="/MassTransit/assets/js/83.899fe852.js"><link rel="prefetch" href="/MassTransit/assets/js/84.7fb595a1.js"><link rel="prefetch" href="/MassTransit/assets/js/85.05972788.js"><link rel="prefetch" href="/MassTransit/assets/js/86.c4fdf3b1.js"><link rel="prefetch" href="/MassTransit/assets/js/87.7caa98a0.js"><link rel="prefetch" href="/MassTransit/assets/js/88.93d28381.js"><link rel="prefetch" href="/MassTransit/assets/js/89.cca0c0da.js"><link rel="prefetch" href="/MassTransit/assets/js/9.e44e6573.js"><link rel="prefetch" href="/MassTransit/assets/js/90.a5271be3.js"><link rel="prefetch" href="/MassTransit/assets/js/91.7c2ab6d7.js"><link rel="prefetch" href="/MassTransit/assets/js/92.e7602d7b.js"><link rel="prefetch" href="/MassTransit/assets/js/93.7085c7ed.js"><link rel="prefetch" href="/MassTransit/assets/js/94.80cdb40c.js"><link rel="prefetch" href="/MassTransit/assets/js/95.2f02370f.js"><link rel="prefetch" href="/MassTransit/assets/js/96.435c4c8b.js"><link rel="prefetch" href="/MassTransit/assets/js/97.b9149593.js"><link rel="prefetch" href="/MassTransit/assets/js/98.27982cf5.js"><link rel="prefetch" href="/MassTransit/assets/js/99.2b4ae788.js">
    <link rel="stylesheet" href="/MassTransit/assets/css/0.styles.3c3540eb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/MassTransit/" class="home-link router-link-active"><img src="/MassTransit/mt-logo-small.png" alt="MassTransit" class="logo"> <span class="site-name can-hide">MassTransit</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://gitter.im/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitter
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://gitter.im/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitter
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/MassTransit/getting-started/" class="sidebar-heading clickable"><span>Getting Started</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/MassTransit/getting-started/upgrade-v6.html" class="sidebar-link">Upgrading</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/MassTransit/usage/" class="sidebar-heading clickable router-link-active open"><span>Using MassTransit</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/MassTransit/usage/configuration.html" class="active sidebar-link">Configuration</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/MassTransit/usage/configuration.html#console-application" class="sidebar-link">Console application</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/configuration.html#asp-net-core" class="sidebar-link">ASP.NET Core</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/configuration.html#windows-service" class="sidebar-link">Windows service</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/configuration.html#web-application" class="sidebar-link">Web application</a></li></ul></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/MassTransit/usage/transports/" class="sidebar-heading clickable"><span>Transports</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/MassTransit/usage/messages.html" class="sidebar-link">Messages</a></li><li><a href="/MassTransit/usage/consumers.html" class="sidebar-link">Consumers</a></li><li><a href="/MassTransit/usage/producers.html" class="sidebar-link">Producers</a></li><li><a href="/MassTransit/usage/exceptions.html" class="sidebar-link">Exceptions</a></li><li><a href="/MassTransit/usage/requests.html" class="sidebar-link">Requests</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/MassTransit/usage/sagas/" class="sidebar-heading clickable"><span>Sagas</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/MassTransit/usage/containers/" class="sidebar-heading clickable"><span>Containers</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/MassTransit/usage/testing.html" class="sidebar-link">Testing</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Advanced</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MassTransit/learn/" class="sidebar-heading clickable"><span>Getting Help</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Reference</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="configuration"><a href="#configuration" class="header-anchor">#</a> Configuration</h1> <p>MassTransit can be used in any .NET application, however, the application type can influence the bus configuration. Several different application type examples are shwon below, each of which lists any additional dependencies are required. Each example focuses on simplicity, and therefore may omit certain extra features to avoid confusion.</p> <div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>Except where required by the application type, no dependency injection container is used. For container configuration examples, refer to the <a href="/usage/containers">containers</a> section.</p></div> <h2 id="console-application"><a href="#console-application" class="header-anchor">#</a> Console application</h2> <p>A console application has a <code>Main</code> entry point, which is part of the <code>Program.cs</code> class by default. The example below configures a simple bus instance that publishes an event with a value entered.</p> <blockquote><p>References: <a href="https://nuget.org/packages/MassTransit.RabbitMQ/" target="_blank" rel="noopener noreferrer">MassTransit.RabbitMQ<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">namespace</span> EventPublisher
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> MassTransit<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ValueEntered</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">string</span> Value <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// be sure to set the C# language version to 7.3 or later</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token class-name">Task</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">var</span> busControl <span class="token operator">=</span> Bus<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">CreateUsingRabbitMq</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span> cfg<span class="token punctuation">.</span><span class="token function">Host</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Important! The bus must be started before using it!</span>
            <span class="token keyword">await</span> busControl<span class="token punctuation">.</span><span class="token function">StartAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">do</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">string</span> <span class="token keyword">value</span> <span class="token operator">=</span> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
                    <span class="token punctuation">{</span>
                        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Enter message (or quit to exit)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        Console<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">&quot;&gt; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> Console<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">&quot;quit&quot;</span><span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">,</span> StringComparison<span class="token punctuation">.</span>OrdinalIgnoreCase<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>

                    <span class="token keyword">await</span> busControl<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Publish</span><span class="token punctuation">&lt;</span><span class="token class-name">ValueEntered</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span>
                    <span class="token punctuation">{</span>
                        Value <span class="token operator">=</span> <span class="token keyword">value</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">finally</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">await</span> busControl<span class="token punctuation">.</span><span class="token function">StopAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In the example, the bus is configured and started after which a publishing loop allows values to be entered and published. When the loop exits, the bus is stopped.</p> <div class="custom-block warning"><p class="custom-block-title">REMEMBER</p> <p>Always start the bus before using it.</p></div> <h2 id="asp-net-core"><a href="#asp-net-core" class="header-anchor">#</a> ASP.NET Core</h2> <p>MassTransit integrates natively with ASP.NET Core, and supports:</p> <ul><li>Hosted service to start and stop the bus following the application lifecycle</li> <li>Registers the bus instance as a singleton for the required interfaces</li> <li>Adds health checks for the bus instance and receive endpoints</li> <li>Configures the bus to use the host process <code>ILoggerFactory</code> instance</li></ul> <p>If you want to register your consumers in the ASP.NET Core service collection, use the following code as an example:</p> <blockquote><p>References: <a href="https://nuget.org/packages/MassTransit.AspNetCore/" target="_blank" rel="noopener noreferrer">MassTransit.AspNetCore<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://nuget.org/packages/MassTransit.RabbitMQ/" target="_blank" rel="noopener noreferrer">MassTransit.RabbitMQ<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Startup</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Add framework services</span>
        services<span class="token punctuation">.</span><span class="token function">AddHealthChecks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        services<span class="token punctuation">.</span><span class="token function">AddMvc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Consumer dependencies should be scoped</span>
        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token punctuation">&lt;</span><span class="token class-name">SomeConsumerDependency</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// local function to create the bus</span>
        <span class="token class-name">IBusControl</span> <span class="token function">CreateBus</span><span class="token punctuation">(</span><span class="token class-name">IServiceProvider</span> serviceProvider<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> Bus<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">CreateUsingRabbitMq</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                cfg<span class="token punctuation">.</span><span class="token function">Host</span><span class="token punctuation">(</span><span class="token string">&quot;rabbitmq://localhost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;submit-order&quot;</span><span class="token punctuation">,</span> ep <span class="token operator">=&gt;</span>
                <span class="token punctuation">{</span>
                    ep<span class="token punctuation">.</span>PrefetchCount <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
                    ep<span class="token punctuation">.</span><span class="token function">UseMessageRetry</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">Interval</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    ep<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConfigureConsumer</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderConsumer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// local function to configure consumers</span>
        <span class="token keyword">void</span> <span class="token function">ConfigureMassTransit</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollectionConfigurator</span> configurator<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            configurator<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddConsumer</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderConsumer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// configures MassTransit to integrate with the built-in dependency injection</span>
        services<span class="token punctuation">.</span><span class="token function">AddMassTransit</span><span class="token punctuation">(</span>CreateBus<span class="token punctuation">,</span> ConfigureMassTransit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Remember, however, that it is perfectly fine to set up all the required dependencies in the <code>Startup</code>, which serves as the bootstrap code for your application. By doing that you can avoid weird cases when you have two dependencies that implement the same interface and then you cannot properly register them both, since only the last one will count.</p> <p>Here is how you can avoid using the container:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Startup</span>
<span class="token punctuation">{</span>
    <span class="token class-name">IConfiguration</span> Configuration <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token class-name">ILoggerFactory</span> LoggerFactory <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">Startup</span><span class="token punctuation">(</span><span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">,</span> <span class="token class-name">ILoggerFactory</span> loggerFactory<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Configuration <span class="token operator">=</span> configuration<span class="token punctuation">;</span>
        LoggerFactory <span class="token operator">=</span> loggerFactory<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Add framework services</span>
        services<span class="token punctuation">.</span><span class="token function">AddHealthChecks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        services<span class="token punctuation">.</span><span class="token function">AddMvc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Using factory delegates for transient dependencies</span>
        <span class="token keyword">var</span> someDependencyFactory <span class="token operator">=</span> 
            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">SomeDependency</span><span class="token punctuation">(</span>Configuration<span class="token punctuation">[</span><span class="token string">&quot;connectionStrings:mySqlDatabase&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Using instances for singletons</span>
        <span class="token keyword">var</span> anotherDependency <span class="token operator">=</span> 
            <span class="token keyword">new</span> <span class="token class-name">SomeDocumentStore</span><span class="token punctuation">(</span>Configuration<span class="token punctuation">[</span><span class="token string">&quot;connectionString:documentStore&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Register MassTransit. Here we need to send the logger factory.</span>
        services<span class="token punctuation">.</span><span class="token function">AddMassTransit</span><span class="token punctuation">(</span><span class="token function">ConfigureBus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> LoggerFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">IBusControl</span> <span class="token function">ConfigureBus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Bus<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">CreateUsingRabbitMq</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        cfg<span class="token punctuation">.</span><span class="token function">Host</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;submit-order&quot;</span><span class="token punctuation">,</span> ep <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            ep<span class="token punctuation">.</span>PrefetchCount <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
            ep<span class="token punctuation">.</span><span class="token function">UseMessageRetry</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">Interval</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            ep<span class="token punctuation">.</span><span class="token function">Consumer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">OrderConsumer</span><span class="token punctuation">(</span><span class="token function">someDependency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> anotherDependency<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>To make the health checks work, remember to add this line to the <code>Configure</code> method in the <code>Startup.cs</code> file:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">UseHealthChecks</span><span class="token punctuation">(</span><span class="token string">&quot;/health&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HealthCheckOptions</span> <span class="token punctuation">{</span>Predicate <span class="token operator">=</span> check <span class="token operator">=&gt;</span> check<span class="token punctuation">.</span>Tags<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token string">&quot;ready&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Also, as an obvious requirement, you need to use .NET Core 2.2 (or higher) and have those two package references in your project file:</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Microsoft.AspNetCore.Diagnostics<span class="token punctuation">&quot;</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>2.2.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Microsoft.AspNetCore.Diagnostics.HealthChecks<span class="token punctuation">&quot;</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>2.2.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>Of course, health checks only work when you provide an endpoint that is accessible via http or https. That implies that you cannot do that using the <code>Microsoft.NET.Sdk</code>, so you need to ensure that your <code>csproj</code> file starts with this line:</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Project</span> <span class="token attr-name">Sdk</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Microsoft.NET.Sdk.Web<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>The Web SDK is used by default if you are using the ASP.NET Core Web Application template, but you can also change it, if you used the Console Application template. In such a case you'd also need to add some more packages to be able to host the http endpoint using Kestrel. The easiest way to migrate a console application to the web application (that still runs as a console application) by creating a new web application with the type <code>Empty</code> and checking the differences.</p> <h2 id="windows-service"><a href="#windows-service" class="header-anchor">#</a> Windows service</h2> <p>A Windows service is recommended for consuming commands and events as it provides an autonomous execution environment for message consumers. The service can be started and stopped using the service control manager, as well as monitored by operations tools.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>To create a Windows service, we strongly recommend using Topshelf, as it was built specifically for this purpose. Topshelf is easy to use, has zero dependencies, and creates a service that can be self-installed without additional tools.</p></div> <p>The important aspect of configuring a bus in a Windows service is to ensure that the bus is only configured and started when the service is <em>started</em>.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">namespace</span> EventService
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> MassTransit<span class="token punctuation">;</span>
    <span class="token keyword">using</span> Topshelf<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>HostFactory<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span> cfg<span class="token punctuation">.</span><span class="token function">Service</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">EventConsumerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">class</span> <span class="token class-name">EventConsumerService</span> <span class="token punctuation">:</span>
        <span class="token class-name">ServiceControl</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">IBusControl</span> _bus<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">bool</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token class-name">HostControl</span> hostControl<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _bus <span class="token operator">=</span> <span class="token function">ConfigureBus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _bus<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">bool</span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token class-name">HostControl</span> hostControl<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _bus<span class="token punctuation">?.</span><span class="token function">Stop</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">IBusControl</span> <span class="token function">ConfigureBus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> Bus<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">CreateUsingRabbitMq</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                cfg<span class="token punctuation">.</span><span class="token function">Host</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;event_queue&quot;</span><span class="token punctuation">,</span> e <span class="token operator">=&gt;</span>
                <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handler</span><span class="token punctuation">&lt;</span><span class="token class-name">ValueEntered</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span>
                        Console<span class="token punctuation">.</span>Out<span class="token punctuation">.</span><span class="token function">WriteLineAsync</span><span class="token punctuation">(</span>$<span class="token string">&quot;Value was entered: {context.Message.Value}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="web-application"><a href="#web-application" class="header-anchor">#</a> Web application</h2> <p>Configuring a bus in a web site is typically done to publish events, send commands, as well as engage in request/response conversations. Hosting receive endpoints and persistent consumers is not recommended (use a service as shown above).</p> <h3 id="asp-net-mvc-webapi2"><a href="#asp-net-mvc-webapi2" class="header-anchor">#</a> ASP.NET (MVC/WebApi2)</h3> <p>In a web application, the <code>HttpApplication</code> class methods of <code>Application_Start</code> and <code>Application_End</code> are used to configure/start the bus and stop the bus respectively.</p> <blockquote><p>While many MassTransit samples use Topshelf, web applications are an exception where the standard web application conventions are followed.</p></blockquote> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MvcApplication</span> <span class="token punctuation">:</span> <span class="token class-name">HttpApplication</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token class-name">IBusControl</span> _busControl<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">IBus</span> Bus
    <span class="token punctuation">{</span>
        <span class="token keyword">get</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> _busControl<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">Application_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _busControl <span class="token operator">=</span> <span class="token function">ConfigureBus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _busControl<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">Application_End</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _busControl<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">IBusControl</span> <span class="token function">ConfigureBus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Bus<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">CreateUsingRabbitMq</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            cfg<span class="token punctuation">.</span><span class="token function">Host</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NotifyController</span> <span class="token punctuation">:</span> <span class="token class-name">Controller</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>ActionResult<span class="token operator">&gt;</span> <span class="token function">Put</span><span class="token punctuation">(</span><span class="token keyword">string</span> <span class="token keyword">value</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> MvcApplication<span class="token punctuation">.</span>Bus<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Publish</span><span class="token punctuation">&lt;</span><span class="token class-name">ValueNotified</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span>
        <span class="token punctuation">{</span>
            Value <span class="token operator">=</span> <span class="token keyword">value</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommandController</span> <span class="token punctuation">:</span> <span class="token class-name">Controller</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>ActionResult<span class="token operator">&gt;</span> <span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">string</span> <span class="token keyword">value</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> endpoint <span class="token operator">=</span> <span class="token keyword">await</span> MvcApplication<span class="token punctuation">.</span>Bus<span class="token punctuation">.</span><span class="token function">GetSendEndpoint</span><span class="token punctuation">(</span>_serviceAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> endpoint<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Send</span><span class="token punctuation">&lt;</span><span class="token class-name">SubmitValue</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span>
        <span class="token punctuation">{</span>
            Timestamp <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span>
            Value <span class="token operator">=</span> <span class="token keyword">value</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The above example is kept simple, providing a static <code>MvcApplication.Bus</code> property to access the bus instance (for publishing events, and sending commands to endpoints). Newer version of ASP.NET have built-in dependency resolution, in which case the <code>IBus</code> should be registered so that controllers can specify the dependency in the constructor. In fact, the inherited <code>IPublishEndpoint</code> and <code>ISendEndpointProvider</code> should also be registered.</p> <p>The example controllers show how to publish and send messages as well.</p> <h3 id="owin-pipeline-webapi2"><a href="#owin-pipeline-webapi2" class="header-anchor">#</a> OWIN Pipeline (WebApi2)</h3> <p>WebApi2 can alternatively use the OWIN pipeline. But OWIN doesn't have <code>Application_End</code> and so it requires a different approach to ensure the bus is disposed properly.</p> <p>This example shows an OWIN WebApi2 project using the Autofac Container. The concept should be similar if you aren't using WebApi2 or a different Container, but still OWIN.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Startup</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configuration</span><span class="token punctuation">(</span><span class="token class-name">IAppBuilder</span> app<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// STANDARD WEB API SETUP:</span>

        <span class="token comment">// Get your HttpConfiguration. In OWIN, you'll create one</span>
        <span class="token comment">// rather than using GlobalConfiguration.</span>
        <span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        WebApiConfig<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Register your routes</span>

        <span class="token comment">// Make the autofac container</span>
        <span class="token keyword">var</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContainerBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Register your Bus</span>
        builder<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> Bus<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">CreateUsingRabbitMq</span><span class="token punctuation">(</span>sbc <span class="token operator">=&gt;</span> sbc<span class="token punctuation">.</span><span class="token function">Host</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;dev&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">As</span><span class="token punctuation">&lt;</span><span class="token class-name">IBusControl</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">As</span><span class="token punctuation">&lt;</span><span class="token class-name">IBus</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">As</span><span class="token punctuation">&lt;</span><span class="token class-name">IPublishEndpoint</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">As</span><span class="token punctuation">&lt;</span><span class="token class-name">ISendEndpointProvider</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">SingleInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Register anything else you might need...</span>

        <span class="token comment">// Build the container</span>
        <span class="token keyword">var</span> container <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// OWIN WEB API SETUP:</span>

        <span class="token comment">// set the DependencyResolver</span>
        config<span class="token punctuation">.</span>DependencyResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AutofacWebApiDependencyResolver</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Register the Autofac middleware FIRST, then the Autofac Web API middleware,</span>
        <span class="token comment">// and finally the standard Web API middleware.</span>

        app<span class="token punctuation">.</span><span class="token function">UseAutofacMiddleware</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">UseAutofacWebApi</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">UseWebApi</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Starts Mass Transit Service bus, and registers stopping of bus on app dispose</span>
        <span class="token keyword">var</span> bus <span class="token operator">=</span> container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Resolve</span><span class="token punctuation">&lt;</span><span class="token class-name">IBusControl</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> busHandle <span class="token operator">=</span> bus<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppProperties</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>Properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span>OnAppDisposing <span class="token operator">!=</span> CancellationToken<span class="token punctuation">.</span>None<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            properties<span class="token punctuation">.</span>OnAppDisposing<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> busHandle<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The important bit is the last several lines where we resolve the <code>IBusControl</code> and register an action to stop when the app disposes.</p> <p>You'll also notice we registered the bus <code>.As&lt;IPublishEndpoint&gt;()</code>. That's because we are following the guidance above, where our websites should really only be Publishing to the service bus.</p> <p>Now your controller might look like:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyController</span> <span class="token punctuation">:</span> <span class="token class-name">ApiController</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IPublishEndpoint</span> _publishEndpoint<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">MyController</span><span class="token punctuation">(</span><span class="token class-name">IPublishEndpoint</span> publishEndpoint<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _publishEndpoint <span class="token operator">=</span> publishEndpoint<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token class-name">HttpPost</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>IHttpActionResult<span class="token operator">&gt;</span> <span class="token function">OrderShipped</span><span class="token punctuation">(</span><span class="token keyword">int</span> orderId<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> _publishEndpoint<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Publish</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderShipped</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
        <span class="token keyword">new</span>
        <span class="token punctuation">{</span>
            OrderId <span class="token operator">=</span> orderId
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token string">&quot;Success!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/MassTransit/MassTransit/edit/develop/docs/usage/configuration.md" target="_blank" rel="noopener noreferrer">Help us by improving this page!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/11/2019, 3:58:22 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/MassTransit/getting-started/upgrade-v6.html" class="prev">Upgrading</a></span> <span class="next"><a href="/MassTransit/usage/transports/rabbitmq.html">RabbitMQ</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/MassTransit/assets/js/app.35715e6f.js" defer></script><script src="/MassTransit/assets/js/2.d01194ec.js" defer></script><script src="/MassTransit/assets/js/72.4e7b6ada.js" defer></script>
  </body>
</html>
