<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Saga Persistence | MassTransit</title>
    <meta name="description" content="A free, open-source distributed application framework for .NET.">
    
    
    <link rel="preload" href="/MassTransit/assets/css/0.styles.3c3540eb.css" as="style"><link rel="preload" href="/MassTransit/assets/js/app.35715e6f.js" as="script"><link rel="preload" href="/MassTransit/assets/js/2.d01194ec.js" as="script"><link rel="preload" href="/MassTransit/assets/js/97.b9149593.js" as="script"><link rel="prefetch" href="/MassTransit/assets/js/10.4c8ec4ee.js"><link rel="prefetch" href="/MassTransit/assets/js/100.a4922aba.js"><link rel="prefetch" href="/MassTransit/assets/js/101.28301740.js"><link rel="prefetch" href="/MassTransit/assets/js/102.4da7841b.js"><link rel="prefetch" href="/MassTransit/assets/js/103.55327799.js"><link rel="prefetch" href="/MassTransit/assets/js/104.c327e2ce.js"><link rel="prefetch" href="/MassTransit/assets/js/105.03546a12.js"><link rel="prefetch" href="/MassTransit/assets/js/106.fca1c0dc.js"><link rel="prefetch" href="/MassTransit/assets/js/11.ae22c166.js"><link rel="prefetch" href="/MassTransit/assets/js/12.697658b9.js"><link rel="prefetch" href="/MassTransit/assets/js/13.7b86bb52.js"><link rel="prefetch" href="/MassTransit/assets/js/14.be5c99d8.js"><link rel="prefetch" href="/MassTransit/assets/js/15.d0f537bf.js"><link rel="prefetch" href="/MassTransit/assets/js/16.cbfcd2ad.js"><link rel="prefetch" href="/MassTransit/assets/js/17.0c1291de.js"><link rel="prefetch" href="/MassTransit/assets/js/18.3a0ff71b.js"><link rel="prefetch" href="/MassTransit/assets/js/19.5c3468d1.js"><link rel="prefetch" href="/MassTransit/assets/js/20.00f55e73.js"><link rel="prefetch" href="/MassTransit/assets/js/21.0e5ecf82.js"><link rel="prefetch" href="/MassTransit/assets/js/22.e77c30a0.js"><link rel="prefetch" href="/MassTransit/assets/js/23.2ccaddf7.js"><link rel="prefetch" href="/MassTransit/assets/js/24.e5122a93.js"><link rel="prefetch" href="/MassTransit/assets/js/25.ff9934c4.js"><link rel="prefetch" href="/MassTransit/assets/js/26.c96a8535.js"><link rel="prefetch" href="/MassTransit/assets/js/27.42f0b0e8.js"><link rel="prefetch" href="/MassTransit/assets/js/28.b139b450.js"><link rel="prefetch" href="/MassTransit/assets/js/29.44427ee4.js"><link rel="prefetch" href="/MassTransit/assets/js/3.0af1cfd3.js"><link rel="prefetch" href="/MassTransit/assets/js/30.a3c7546f.js"><link rel="prefetch" href="/MassTransit/assets/js/31.26d3b153.js"><link rel="prefetch" href="/MassTransit/assets/js/32.21c8d85c.js"><link rel="prefetch" href="/MassTransit/assets/js/33.60e822ec.js"><link rel="prefetch" href="/MassTransit/assets/js/34.83670677.js"><link rel="prefetch" href="/MassTransit/assets/js/35.7121ef0d.js"><link rel="prefetch" href="/MassTransit/assets/js/36.b3bdb7a7.js"><link rel="prefetch" href="/MassTransit/assets/js/37.fd50b8c6.js"><link rel="prefetch" href="/MassTransit/assets/js/38.ca1af769.js"><link rel="prefetch" href="/MassTransit/assets/js/39.8a01e6c2.js"><link rel="prefetch" href="/MassTransit/assets/js/4.59116900.js"><link rel="prefetch" href="/MassTransit/assets/js/40.d28c9f0a.js"><link rel="prefetch" href="/MassTransit/assets/js/41.98667d2f.js"><link rel="prefetch" href="/MassTransit/assets/js/42.f39f09a4.js"><link rel="prefetch" href="/MassTransit/assets/js/43.1e05245e.js"><link rel="prefetch" href="/MassTransit/assets/js/44.4e17f750.js"><link rel="prefetch" href="/MassTransit/assets/js/45.8d1d7271.js"><link rel="prefetch" href="/MassTransit/assets/js/46.b2dbac86.js"><link rel="prefetch" href="/MassTransit/assets/js/47.f1aa8bbb.js"><link rel="prefetch" href="/MassTransit/assets/js/48.44c78fa3.js"><link rel="prefetch" href="/MassTransit/assets/js/49.083d197d.js"><link rel="prefetch" href="/MassTransit/assets/js/5.1d3e2cf6.js"><link rel="prefetch" href="/MassTransit/assets/js/50.acdb5188.js"><link rel="prefetch" href="/MassTransit/assets/js/51.368b1bb1.js"><link rel="prefetch" href="/MassTransit/assets/js/52.a16ac88f.js"><link rel="prefetch" href="/MassTransit/assets/js/53.747838c5.js"><link rel="prefetch" href="/MassTransit/assets/js/54.88a4e8f0.js"><link rel="prefetch" href="/MassTransit/assets/js/55.1ed74524.js"><link rel="prefetch" href="/MassTransit/assets/js/56.d6be0941.js"><link rel="prefetch" href="/MassTransit/assets/js/57.ec053e4a.js"><link rel="prefetch" href="/MassTransit/assets/js/58.89897b01.js"><link rel="prefetch" href="/MassTransit/assets/js/59.b03c9a56.js"><link rel="prefetch" href="/MassTransit/assets/js/6.7d02cd3b.js"><link rel="prefetch" href="/MassTransit/assets/js/60.6f5c5a8e.js"><link rel="prefetch" href="/MassTransit/assets/js/61.22b788f0.js"><link rel="prefetch" href="/MassTransit/assets/js/62.7a46067b.js"><link rel="prefetch" href="/MassTransit/assets/js/63.fa629e14.js"><link rel="prefetch" href="/MassTransit/assets/js/64.461d2327.js"><link rel="prefetch" href="/MassTransit/assets/js/65.3be2b22c.js"><link rel="prefetch" href="/MassTransit/assets/js/66.088eaa99.js"><link rel="prefetch" href="/MassTransit/assets/js/67.aa4a0e42.js"><link rel="prefetch" href="/MassTransit/assets/js/68.2343f41a.js"><link rel="prefetch" href="/MassTransit/assets/js/69.5760c371.js"><link rel="prefetch" href="/MassTransit/assets/js/7.d34c132d.js"><link rel="prefetch" href="/MassTransit/assets/js/70.1b795a08.js"><link rel="prefetch" href="/MassTransit/assets/js/71.5f851dc4.js"><link rel="prefetch" href="/MassTransit/assets/js/72.4e7b6ada.js"><link rel="prefetch" href="/MassTransit/assets/js/73.0c270da4.js"><link rel="prefetch" href="/MassTransit/assets/js/74.ed350914.js"><link rel="prefetch" href="/MassTransit/assets/js/75.96bac087.js"><link rel="prefetch" href="/MassTransit/assets/js/76.8164340d.js"><link rel="prefetch" href="/MassTransit/assets/js/77.be02c6e3.js"><link rel="prefetch" href="/MassTransit/assets/js/78.1af2718f.js"><link rel="prefetch" href="/MassTransit/assets/js/79.4a5eab4b.js"><link rel="prefetch" href="/MassTransit/assets/js/8.3bb286ea.js"><link rel="prefetch" href="/MassTransit/assets/js/80.2f525084.js"><link rel="prefetch" href="/MassTransit/assets/js/81.20e04321.js"><link rel="prefetch" href="/MassTransit/assets/js/82.eb5a0b20.js"><link rel="prefetch" href="/MassTransit/assets/js/83.899fe852.js"><link rel="prefetch" href="/MassTransit/assets/js/84.7fb595a1.js"><link rel="prefetch" href="/MassTransit/assets/js/85.05972788.js"><link rel="prefetch" href="/MassTransit/assets/js/86.c4fdf3b1.js"><link rel="prefetch" href="/MassTransit/assets/js/87.7caa98a0.js"><link rel="prefetch" href="/MassTransit/assets/js/88.93d28381.js"><link rel="prefetch" href="/MassTransit/assets/js/89.cca0c0da.js"><link rel="prefetch" href="/MassTransit/assets/js/9.e44e6573.js"><link rel="prefetch" href="/MassTransit/assets/js/90.a5271be3.js"><link rel="prefetch" href="/MassTransit/assets/js/91.7c2ab6d7.js"><link rel="prefetch" href="/MassTransit/assets/js/92.e7602d7b.js"><link rel="prefetch" href="/MassTransit/assets/js/93.7085c7ed.js"><link rel="prefetch" href="/MassTransit/assets/js/94.80cdb40c.js"><link rel="prefetch" href="/MassTransit/assets/js/95.2f02370f.js"><link rel="prefetch" href="/MassTransit/assets/js/96.435c4c8b.js"><link rel="prefetch" href="/MassTransit/assets/js/98.27982cf5.js"><link rel="prefetch" href="/MassTransit/assets/js/99.2b4ae788.js">
    <link rel="stylesheet" href="/MassTransit/assets/css/0.styles.3c3540eb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/MassTransit/" class="home-link router-link-active"><img src="/MassTransit/mt-logo-small.png" alt="MassTransit" class="logo"> <span class="site-name can-hide">MassTransit</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://gitter.im/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitter
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://gitter.im/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitter
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/MassTransit/getting-started/" class="sidebar-heading clickable"><span>Getting Started</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/MassTransit/getting-started/upgrade-v6.html" class="sidebar-link">Upgrading</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/MassTransit/usage/" class="sidebar-heading clickable router-link-active open"><span>Using MassTransit</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/MassTransit/usage/configuration.html" class="sidebar-link">Configuration</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/MassTransit/usage/transports/" class="sidebar-heading clickable"><span>Transports</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/MassTransit/usage/messages.html" class="sidebar-link">Messages</a></li><li><a href="/MassTransit/usage/consumers.html" class="sidebar-link">Consumers</a></li><li><a href="/MassTransit/usage/producers.html" class="sidebar-link">Producers</a></li><li><a href="/MassTransit/usage/exceptions.html" class="sidebar-link">Exceptions</a></li><li><a href="/MassTransit/usage/requests.html" class="sidebar-link">Requests</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/MassTransit/usage/sagas/" class="sidebar-heading clickable router-link-active open"><span>Sagas</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/MassTransit/usage/sagas/automatonymous.html" class="sidebar-link">Automatonymous</a></li><li><a href="/MassTransit/usage/sagas/persistence.html" class="active sidebar-link">Saga Persistence</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/persistence.html#entity-framework" class="sidebar-link">Entity Framework</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/persistence.html#mongodb" class="sidebar-link">MongoDB</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/persistence.html#nhibernate" class="sidebar-link">NHibernate</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/persistence.html#redis" class="sidebar-link">Redis</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/persistence.html#marten" class="sidebar-link">Marten</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/persistence.html#documentdb" class="sidebar-link">DocumentDb</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/persistence.html#azure-service-bus" class="sidebar-link">Azure Service Bus</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/persistence.html#dapper" class="sidebar-link">Dapper</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/MassTransit/usage/containers/" class="sidebar-heading clickable"><span>Containers</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/MassTransit/usage/testing.html" class="sidebar-link">Testing</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Advanced</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MassTransit/learn/" class="sidebar-heading clickable"><span>Getting Help</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Reference</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="saga-persistence"><a href="#saga-persistence" class="header-anchor">#</a> Saga Persistence</h1> <p>Sagas are stateful event-based message consumers -- they retain state. Therefore, saving state between events is important. Without persistent state, a saga would consider each event a new event, and orchestration of subsequent events would be meaningless.</p> <ul><li><a href="#specifying-saga-persistence">Specifying saga persistence</a></li> <li><a href="#identity">Identity</a></li> <li><a href="#publishing-and-sending-from-sagas">Publishing and Sending From Sagas</a></li> <li><a href="#storage-engines">Storage Engines</a> <ul><li><a href="#entity-framework">Entity Framework</a></li> <li><a href="#mongodb">MongoDB</a></li> <li><a href="#nhibernate">NHibernate</a></li> <li><a href="#redis">Redis</a></li> <li><a href="#marten">Marten</a></li> <li><a href="#documentdb">DocumentDb</a></li> <li><a href="#azure-service-bus">Azure Service Bus</a></li></ul></li></ul> <p>In order to store the saga state, you need to use one form of saga persistence. There are several types of storage that MassTransit supports, all of those, which are included to the main distribution, are listed below. There is also a in-memory unreliable storage, which allows to temporarily store your saga state. It is useful to try things out since it does not require any infrastructure.</p> <p>Simple initialization of a state machine saga with persistence looks like this:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> sagaStateMachine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShoppingCartStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> repository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">InMemorySagaRepository</span><span class="token punctuation">&lt;</span><span class="token class-name">ShoppingCart</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> busControl <span class="token operator">=</span> Bus<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">CreateUsingRabbitMq</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    x<span class="token punctuation">.</span><span class="token function">Host</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    x<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;shopping_cart_state&quot;</span><span class="token punctuation">,</span> e <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">StateMachineSaga</span><span class="token punctuation">(</span>sagaStateMachine<span class="token punctuation">,</span> repository<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>It is important to notice that the saga repository object is a singleton. It does not hold any state inside the class instance and only performs operations on the saga state objects that are send to it to persist and retrieve.</p> <p>There are two types of saga repository:</p> <ul><li>Query repository</li> <li>Identity-only repository</li></ul> <p>Depending on the persistence mechanism, repository implementation can be either identity-only or identity plus query.</p> <p>When using identity-only repository, such as Azure Service Bus message session or Redis, you can only use correlation by identity. This means that all events that the saga receives, must hold the saga correlation id, and the correlation for each event can only use <code>CorrelateById</code> method to define the correlation.</p> <p>Query repository by definition support identity correlation too, but in addition support other properties of events being received and saga state properties. Such correlations are defined using <code>CorrelateBy</code> method and you can use any logical expression that involve the event data and saga state data to establish such correlation. Repository implementation such as Entity Framework, NHibernate and Marten support correlation by query. Of course, in-memory repository supports it as well.</p> <h3 id="identity"><a href="#identity" class="header-anchor">#</a> Identity</h3> <p>Saga instances are identified by a unique identifier (<code>Guid</code>), represented by the <code>CorrelationId</code> on the saga instance. Events are correlated to the saga instance using either the unique identifier, or alternatively using an expression that correlates properties on the saga instance to each event. If the <code>CorrelationId</code> is used, it's always a one-to-one match, either the saga already exists, or it's a new saga instance. With a correlation expression, the expression might match to more than one saga instance, so care should be used -- because the event would be delivered to all matching instances.</p> <blockquote><p>Seriously, don't sent an event to all instances -- unless you want to watch your messages consumers lock your entire saga storage engine.</p></blockquote> <p>It is strongly advised to have <code>CorrelationId</code> as your table/document key. This will enable better concurrency handling and will make the saga state consistent.</p> <h3 id="publishing-and-sending-from-sagas"><a href="#publishing-and-sending-from-sagas" class="header-anchor">#</a> Publishing and Sending From Sagas</h3> <p>Sagas are completely message-driven and therefore not only consume but also publish events and send commands. However, if your saga received a lot of messages coming roughly at the same time and the endpoint is set to process multiple messages in parallel - this can lead to a conflict between message processing and saga persistence.</p> <p>This means that there could be more than one saga state updates that are being persisted at the same time. Depending on the saga repository type, this might fail for different reasons - versioning issue, row or table lock or eTag mismatch. All those problems are basically saying that you are having a concurrency issue.</p> <p>It is normal for the saga repository to throw an exception in such case but if your saga is publishing messages, they were already published but the saga state has not been updated. MassTransit will eventually use retry policy on the endpoint and more messages will be send, potentially leading to mess. Or, if there are no retry policies configured, messages might be sent indicating that the process needs to continue but saga instance will be in the old state and will not accept any further messages because they will come in a wrong state.</p> <p>This issue is common and can be solved by postponing the message publish and send operations until all persistence work is done. All messages that should be published, are collected in a buffer, which is called <em>Outbox</em>. MassTransit implements this feature and it can be configured by adding these lines to your endpoint configuration:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>c<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;queue&quot;</span><span class="token punctuation">,</span> e <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">UseInMemoryOutbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// other endpoint configuration here</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="storage-engines"><a href="#storage-engines" class="header-anchor">#</a> Storage Engines</h3> <p>MassTransit supports several storage engines, including NHibernate, Entity Framework, MongoDB and Redis. Each of these are setup in a similar way, but examples are shown below for each engine.</p> <ul><li><a href="#entity-framework">Entity Framework</a></li> <li><a href="#nhibernate">NHibernate</a></li> <li><a href="#mongodb">MongoDB</a></li> <li><a href="#redis">Redis</a></li> <li><a href="#marten">Marten</a></li> <li><a href="#documentdb">DocumentDb</a></li> <li><a href="#azure-service-bus">Azure Service Bus</a></li> <li><a href="#dapper">Dapper</a></li></ul> <h3 id="relational-db-recommendations"><a href="#relational-db-recommendations" class="header-anchor">#</a> Relational DB Recommendations</h3> <p>While it's nice if you are developing a green-field system and you can define your Saga Db Entity with CorrelationId as the Primary Key (Clustered), sometimes we have to work within existing db entities. If this is the case, please remember in order to keep your saga's performing quickly (optimistic OR pessimistic, it doesn't matter), follow the note below.</p> <div class="alert alert-info"><b>Note:</b>
    The CorrelationId should preferably be the Primary Key + Clustered for your saga table. If unable, then it must be a Clustered Index + Unique. And it's also highly recommended to use the NewId package for creating nice Db Friendly guids.
</div> <h3 id="optimistic-vs-pessimistic-concurrency"><a href="#optimistic-vs-pessimistic-concurrency" class="header-anchor">#</a> Optimistic vs pessimistic concurrency</h3> <p>Most persistence mechanisms for sagas supported by MassTransit need some way to guarantee ACID when processing sagas. Because there can be multiple threads <em>consuming</em> multiple bus events meant for the same saga instance, they could end up overwriting each other (race condition).</p> <p>Relational databases can easily handle this by setting the transaction type to <em>serializable</em> or (page/row) locking. This would be considered as <em>pessimistic concurrency</em>.</p> <p>Another way to handle concurrency is to have some attribute like version or timestamp, which updates every time a saga is persisted. By doing that we can instruct the database only to update the record if this attribute matches between what we are trying to persist and what is stored in the database record we are trying to update.</p> <p>This is type of concurrency is called an <em>optimistic concurrency</em>. It doesn't guarantee your unit of work with the database will succeed (must retry after these exceptions), but it also doesn't block anybody else from working within the same database page (not locking the table/page).</p> <h4 id="so-which-one-should-i-use"><a href="#so-which-one-should-i-use" class="header-anchor">#</a> So, which one should I use?</h4> <p>For almost every scenario, it is recommended using the optimistic concurrency, because most state machine logic should be fairly quick.</p> <p>If the chosen persistence method supports optimistic concurrency, race conditions can be handled rather easily by specifying a retry policy for concurrency exceptions or using generic retry policy.</p> <h2 id="entity-framework"><a href="#entity-framework" class="header-anchor">#</a> Entity Framework</h2> <p>Entity Framework seems to be the most common ORM for class-SQL mappings, and SQL is still widely used for storing data. So it's a win to have it supported out of the box by MassTransit.</p> <h4 id="concurrency-handling-for-optimistic"><a href="#concurrency-handling-for-optimistic" class="header-anchor">#</a> Concurrency handling (for optimistic)</h4> <p>Fortunately, Entity Framework is a repository pattern itself, and has a column type <code>[Timestamp]</code> (a.k.a. <code>IsRowVersion</code> with fluent mapping), which will check the value of the column when it starts it's &quot;unit of work&quot; and if that value is the same when updating that row in the database - everybody is happy! But, if that column value is different, then it has been updated elsewhere. So, the Entity Framework will throw a <code>DbUpdateConcurrencyException</code>, which can be handled by a retry policyto fix the concurrency violation.</p> <h4 id="configuration-and-usage"><a href="#configuration-and-usage" class="header-anchor">#</a> Configuration and usage</h4> <p>The code-first mapping example below shows the basics of getting started. The lines have been commented where the additional optimistic concurrency column is needed.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SagaInstance</span> <span class="token punctuation">:</span> <span class="token class-name">SagaStateMachineInstance</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">SagaInstance</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> correlationId<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        CorrelationId <span class="token operator">=</span> correlationId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token function">SagaInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">string</span> CurrentState <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> ServiceName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> RowVersion <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// For Optimistic Concurrency, omit if using pessimistic</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SagaInstanceMap</span> <span class="token punctuation">:</span> <span class="token class-name">SagaClassMapping</span><span class="token operator">&lt;</span>SagaInstance<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">SagaInstanceMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Property</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>CurrentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Property</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>ServiceName<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">Length</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Property</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>RowVersion<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsRowVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// For Optimistic Concurrency, omit if using pessimistic</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>Important:
The <code>SagaClassMapping</code> has default mapping for the <code>CorrelationId</code> as a primary key. If you use your own mapping, you must follow the same convention, or at least make it a Clustered Index + Unique, otherwise there is a big chance to get deadlock exceptions and/or performance issues in case of high throughput.</p></blockquote> <p>The repository is then created on the context factory:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name">SagaDbContextFactory</span> contextFactory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> 
    <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">SagaDbContext</span><span class="token punctuation">&lt;</span><span class="token class-name">SagaInstance</span><span class="token punctuation">,</span> <span class="token class-name">SagaInstanceMap</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>_connectionString<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// For Optimistic</span>
<span class="token keyword">var</span> repository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EntityFrameworkSagaRepository</span><span class="token operator">&lt;</span>SagaInstance<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">CreateOptimistic</span><span class="token punctuation">(</span>contextFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// For Pessimistic</span>
<span class="token keyword">var</span> repository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EntityFrameworkSagaRepository</span><span class="token operator">&lt;</span>SagaInstance<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">CreatePessimistic</span><span class="token punctuation">(</span>contextFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Lastly, the snippet below is <strong><em>only needed for optimistic concurrency</em></strong>, because the saga should retry processing if failure occurred when writing to the database. This snippet is adding <a href="/MassTransit/usage/retries.html">retry policies</a> middleware to the saga receive endpoint from the <a href="#specifying-saga-persistence">first section</a>.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>x<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;shopping_cart_state&quot;</span><span class="token punctuation">,</span> e <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">UseRetry</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">DbUpdateConcurrencyException</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">DbUpdateException</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>y <span class="token operator">=&gt;</span> y<span class="token punctuation">.</span><span class="token class-name">InnerException</span> <span class="token keyword">is</span> <span class="token class-name">SqlException</span> e <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>Number <span class="token operator">==</span> <span class="token number">2627</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This is the SQLServer error code for duplicate key, if you are using another Relational Db, the code might be different</span>
            x<span class="token punctuation">.</span><span class="token function">Interval</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMilliseconds</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Add the retry middleware for optimistic concurrency</span>
    e<span class="token punctuation">.</span><span class="token function">StateMachineSaga</span><span class="token punctuation">(</span>sagaStateMachine<span class="token punctuation">,</span> repository<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Hence, that if you have retry policy without an exception filter, it will also handle the concurrency exception, so explicit configuration is not required in this case.</p> <h4 id="consume-lifetime-scoped-dbcontext"><a href="#consume-lifetime-scoped-dbcontext" class="header-anchor">#</a> Consume Lifetime (Scoped) DBContext</h4> <p>By Default, EF Saga Pipeline will get it's own DBContext using the default implementation of ISagaDbContextFactory which is <code>DelegateSagaDbContextFactory&lt;TSaga&gt;</code>. This will not be shared if
you want to access the same dbContext from within a Saga. So you can implement a delegate factory which
is scoped to the parent lifetime (the lifetime of the Saga Event Consumption).</p> <p>Here is how you would implement it for Autofac. Other containers would have a similar implementation.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AutofacSagaDbContextFactory</span><span class="token operator">&lt;</span>TSaga<span class="token operator">&gt;</span> <span class="token punctuation">:</span>
	ISagaDbContextFactory<span class="token operator">&lt;</span>TSaga<span class="token operator">&gt;</span>
	<span class="token keyword">where</span> TSaga <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> ISaga
<span class="token punctuation">{</span>
	<span class="token keyword">readonly</span> <span class="token class-name">ILifetimeScope</span> _defaultLifetimeScope<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token function">AutofacSagaDbContextFactory</span><span class="token punctuation">(</span><span class="token class-name">ILifetimeScope</span> defaultLifetimeScope<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		_defaultLifetimeScope <span class="token operator">=</span> defaultLifetimeScope<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token class-name">DbContext</span> <span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">return</span> _defaultLifetimeScope<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Resolve</span><span class="token punctuation">&lt;</span><span class="token class-name">DbContext</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> DbContext <span class="token generic-method"><span class="token function">CreateScoped</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>ConsumeContext<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> context<span class="token punctuation">)</span>
		<span class="token keyword">where</span> T <span class="token punctuation">:</span> <span class="token keyword">class</span>
	<span class="token punctuation">{</span>            
		<span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TryGetPayload</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name">ILifetimeScope</span> currentScope<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> currentScope<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Resolve</span><span class="token punctuation">&lt;</span><span class="token class-name">DbContext</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> <span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Release</span><span class="token punctuation">(</span><span class="token class-name">DbContext</span> dbContext<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
        <span class="token comment">// Purposely left blank, the disposal of the dbContext is controlled by the container (autofac in this case)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="mongodb"><a href="#mongodb" class="header-anchor">#</a> MongoDB</h2> <p>MongoDB is an easy to use saga repository, because setup is easy. There is no need for class mapping, the saga instances can be persisted easily using a MongoDB collection.</p> <h4 id="concurrency"><a href="#concurrency" class="header-anchor">#</a> Concurrency</h4> <p>MongoDb saga persistence requires that saga instance classes implement <code>IVersionedSaga</code> interface. This interface has a <code>Version</code> property, which allows the saga persistence to handle optimistic concurrency.</p> <h4 id="configuration-and-usage-2"><a href="#configuration-and-usage-2" class="header-anchor">#</a> Configuration and usage</h4> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SagaInstance</span> <span class="token punctuation">:</span> <span class="token class-name">SagaStateMachineInstance</span><span class="token punctuation">,</span> IVersionedSaga
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">SagaInstance</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> correlationId<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        CorrelationId <span class="token operator">=</span> correlationId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token function">SagaInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">string</span> CurrentState <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> ServiceName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> Version <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The saga repository is created using the simple syntax:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> database <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MongoClient</span><span class="token punctuation">(</span><span class="token string">&quot;mongodb://127.0.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token string">&quot;sagas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> repository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">MongoDbSagaRepository</span><span class="token punctuation">&lt;</span><span class="token class-name">SagaInstance</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Each saga instance will be placed in a collection specific to the instance type.</p> <h2 id="nhibernate"><a href="#nhibernate" class="header-anchor">#</a> NHibernate</h2> <p>NHibernate is a widely used ORM and it is supported by MassTransit for saga storage. The example below shows the code-first approach to using NHibernate for saga persistence.</p> <h4 id="concurrency-2"><a href="#concurrency-2" class="header-anchor">#</a> Concurrency</h4> <p>NHibernate natively supports multiple concurrency handling mechanisms. The easiest is probably adding a <code>Version</code> property of type <code>int</code> to the saga instance class and map it to the column with the same name. NHibernate will use it by default.</p> <h4 id="configuration-and-usage-3"><a href="#configuration-and-usage-3" class="header-anchor">#</a> Configuration and usage</h4> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SagaInstance</span> <span class="token punctuation">:</span> <span class="token class-name">SagaStateMachineInstance</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">SagaInstance</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> correlationId<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        CorrelationId <span class="token operator">=</span> correlationId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token function">SagaInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">string</span> CurrentState <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> ServiceName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> Version <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// for optimistic concurrency</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SagaInstanceMap</span> <span class="token punctuation">:</span> <span class="token class-name">SagaClassMapping</span><span class="token operator">&lt;</span>SagaInstance<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">SagaInstanceMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Property</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>CurrentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Property</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>ServiceName<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">Length</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Property</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Version<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// for optimistic concurrency</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <code>SagaClassMapping</code> base class maps the <code>CorrelationId</code> of the saga, and handles some of the basic bootstrapping of the class map. All other properties, including the property for the <code>CurrentState</code> (if you're using state machine sagas), must be mapped by the developer. Once mapped, the <code>ISessionFactory</code> can be created using NHibernate directly. From the session factory, the saga repository can be created.</p> <blockquote><p>Important:
The <code>SagaClassMapping</code> has default mapping for the <code>CorrelationId</code> as a database generated primary key. If you use your own mapping, you must follow the same convention, otherwise there is a big chance to get deadlock exceptions in case of high throughput.</p></blockquote> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name">ISessionFactory</span> sessionFactory <span class="token operator">=</span> <span class="token function">CreateSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> repository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">NHibernateSagaRepository</span><span class="token punctuation">&lt;</span><span class="token class-name">SagaInstance</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>sessionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="redis"><a href="#redis" class="header-anchor">#</a> Redis</h2> <p>Redis is a very popular key-value store, which is known for being very fast.</p> <p>Redis does not support queries, therefore Redis saga persistence only supports correlation by id. If you try to use correlation by expressions, you will get a &quot;not implemented&quot; exception.</p> <p>Saga persistence for Redis uses <code>StackExchange.Redis</code> library.</p> <h4 id="redis-client-initialization"><a href="#redis-client-initialization" class="header-anchor">#</a> Redis client initialization</h4> <p>Redis saga repository is based on the popular <code>StackExchange.Redis</code> package and therefore requires <code>StackExchange.Redis.IDatabase</code> factory function as constructor parameter. For containerless initialization the code would look like:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> redisConnectionString <span class="token operator">=</span> <span class="token string">&quot;redis://localhost:6379&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> redis <span class="token operator">=</span> ConnectionMultiplexer<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span>redisConnectionString<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> repository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">RedisSagaRepository</span><span class="token punctuation">&lt;</span><span class="token class-name">SagaInstance</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> redis<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>If you want to use a key prefix, you can do:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> redisConnectionString <span class="token operator">=</span> <span class="token string">&quot;redis://localhost:6379&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> redis <span class="token operator">=</span> ConnectionMultiplexer<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span>redisConnectionString<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> repository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">RedisSagaRepository</span><span class="token punctuation">&lt;</span><span class="token class-name">SagaInstance</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> redis<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> keyPrefix<span class="token punctuation">:</span> <span class="token string">&quot;your:key:prefix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>After do that your keys would look like:</p> <div class="language- extra-class"><pre class="language-text"><code>your:key:prefix:c6cfd285-80b2-4c12-bcd3-56a00d994736
</code></pre></div><p>If you use a container, you can use the code like this (example for Autofac):</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> redisConnectionString <span class="token operator">=</span> <span class="token string">&quot;redis://localhost:6379&quot;</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token function">RegisterInstance</span><span class="token punctuation">(</span>ConnectionMultiplexer<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span>redisConnectionString<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">As</span><span class="token punctuation">&lt;</span><span class="token class-name">IConnectionMultiplexer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Register</span><span class="token punctuation">&lt;</span><span class="token class-name">IDatabase</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span>Resolve<span class="token operator">&lt;</span>IConnectionMultiplexer<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token function">RegisterGeneric</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>RedisSagaRepository<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">As</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>ISagaRepository<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SingleInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="concurrency-3"><a href="#concurrency-3" class="header-anchor">#</a> Concurrency</h4> <p>Redis persistence supports optimistic and pessimistic concurrency. The default mode is optomistic concurrency.</p> <p>In optimistic concurrency mode, Redis saga persistence does not acquire locking on the database record when writing it so potentially you can have write conflict in case the saga is updating its state frequently (hundreds of times per second). To resolve this, the saga instance can implement the <code>IVersionedSaga</code> interface and include the Version property:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">int</span> Version <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre></div><p>When the version of the instance that is being updated is lower than the expected version, the saga repository will trow an exception and force the message to be retried, potentially resolving the issue.</p> <p>Pessimistic concurrency can be used by specifying <code>optimistic: false</code> parameter in the repository constructor. It will instruct the repository to use Redis lock mechanism. During the message processing, saga instance in Redis will be locked and any concurrent attempts to execute any processing on the same instance will fail.</p> <h2 id="marten"><a href="#marten" class="header-anchor">#</a> Marten</h2> <p><a href="http://jasperfx.github.io/marten/" target="_blank" rel="noopener noreferrer">Marten<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is an open-source library that provides an API to the PostgreSQL <a href="https://www.postgresql.org/docs/9.5/static/functions-json.html" target="_blank" rel="noopener noreferrer">JSONB storage<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, influenced by RavenDb client API. It allows to use PostgreSQL as schema-less NoSQL document storage. Unlike typical document databases, PostgreSQL JSONB storage provides you the ACID-compliant transactional store with full consistency.</p> <p>To use Marten and PostgreSQL as saga persistence, you need to install <code>MassTransit.Marten</code> NuGet package and add some code.</p> <p>First, your saga state class needs to mark the correlationId property with the <code>[Identity]</code> attribute. By this you inform Marten that correlationId will be used as the primary key.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SampleSaga</span> <span class="token punctuation">:</span> <span class="token class-name">ISaga</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token class-name">Identity</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> State <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> SomeProperty <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Then you need to initialize the document store and the repository. Repository needs the store as its constructor parameter.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> connectionString <span class="token operator">=</span>
    <span class="token string">&quot;server=localhost;port=5432;database=test;user id=test;password=test;&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> store <span class="token operator">=</span> DocumentStore<span class="token punctuation">.</span><span class="token function">For</span><span class="token punctuation">(</span>connectionString<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> repository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">MartenSagaRepository</span><span class="token punctuation">&lt;</span><span class="token class-name">SampleSaga</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>If you use a container, you can use the code like this (example for Autofac):</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> connectionString <span class="token operator">=</span>
    <span class="token string">&quot;server=localhost;port=5432;database=test;user id=test;password=test;&quot;</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Register</span><span class="token punctuation">&lt;</span><span class="token class-name">IDocumentStore</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> DocumentStore<span class="token punctuation">.</span><span class="token function">For</span><span class="token punctuation">(</span>connectionString<span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token function">RegisterGeneric</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>MartenSagaRepository<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">As</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>ISagaRepository<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SingleInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Marten will create the necessary tables for you. This type of saga repository supports correlation by id and custom expressions.</p> <h4 id="concurrency-4"><a href="#concurrency-4" class="header-anchor">#</a> Concurrency</h4> <p>Marten supports optimistic concurrency by using an eTag-like version field in the metadata. This means that the saga instance class does not need any additional fields for version.</p> <p>There are two ways to use this feature:</p> <ol><li>Apply <code>[UseOptimisticConcurrency]</code> attribute to the saga instance class</li></ol> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token class-name">UseOptimisticConcurrency</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SampleSaga</span> <span class="token punctuation">:</span> <span class="token class-name">ISaga</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token class-name">Identity</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>Configure the store to use optimistic concurrency for your saga instance class</li></ol> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> store <span class="token operator">=</span> DocumentStore<span class="token punctuation">.</span><span class="token function">For</span><span class="token punctuation">(</span>_ <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Adds optimistic concurrency checking to Issue</span>
    _<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">For</span><span class="token punctuation">&lt;</span><span class="token class-name">SampleSaga</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UseOptimisticConcurrency</span><span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="documentdb"><a href="#documentdb" class="header-anchor">#</a> DocumentDb</h2> <p>DocumentDb is the predecessor of Azure CosmosDb and the DocumentDb API is still one of the main APIs for the NoSQL document-oriented persistence of CosmosDb. MassTransit supports saga persistence in CosmosDb by using both MongoDb API (using <code>MassTransit.MongoDb</code> package) and using DocumentDb API (using <code>MassTransit.DocumentDb</code> package).</p> <p>DocumentDb requires that any document stored there has a property called <code>id</code>, to be used as the document identity. Saga instances have <code>CorrelationId</code> for the same purpose, so there are two ways to create your DocumentDb saga class, which can have different implications depending on your usage. ETag must also be present, which is used for optimistic concurrency. Please never set this property yourself, it managed 100% by document db.</p> <h4 id="first-the-simple-out-of-box-functionality-create-your-saga-class"><a href="#first-the-simple-out-of-box-functionality-create-your-saga-class" class="header-anchor">#</a> First, the simple (out of box) functionality. Create your saga class:</h4> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SampleSaga</span> <span class="token punctuation">:</span> <span class="token class-name">IVersionedSaga</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> ETag <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> State <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> SomeProperty <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// And in your bus/saga configuration, you explicitly pass in the settings</span>
<span class="token keyword">var</span> repository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">DocumentDbSagaRepository</span><span class="token punctuation">&lt;</span><span class="token class-name">SampleSaga</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>documentDbClient<span class="token punctuation">,</span> <span class="token string">&quot;sagaDatabase&quot;</span><span class="token punctuation">,</span> JsonSerializerSettingsExtensions<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetSagaRenameSettings</span><span class="token punctuation">&lt;</span><span class="token class-name">SimpleSaga</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The only restriction with this method is you might run into trouble if you are using Correlation Expressions that use the CorrelationId property. This is because when passing these expressions into DocumentDb's Create Query, it must have the <code>[JsonProperty(&quot;id&quot;)]</code> attribute instead of using the <code>JsonSerializerSettingsExtensions.GetSagaRenameSettings&lt;...&gt;()</code> rename.</p> <h4 id="so-the-second-option-for-your-saga-class-declaration-is"><a href="#so-the-second-option-for-your-saga-class-declaration-is" class="header-anchor">#</a> So the second option for your saga class declaration is:</h4> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SampleSaga</span> <span class="token punctuation">:</span> <span class="token class-name">IVersionedSaga</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token class-name">JsonProperty</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">[</span><span class="token class-name">JsonProperty</span><span class="token punctuation">(</span><span class="token string">&quot;_etag&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> ETag <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> State <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> SomeProperty <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// And in your bus/saga configuration, just follow the example below, no need to use the GetSagaRenameSettings&lt;&gt;()</span>
</code></pre></div><p>And optionally, you can make your Saga inherit from the Azure DocumentDb class <code>Resource</code>, because.. well why not? It's saving to that store, so you might as well have all the properties there anyways.</p> <h4 id="third-option-for-saga-class-declaration"><a href="#third-option-for-saga-class-declaration" class="header-anchor">#</a> Third option for saga class declaration:</h4> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SampleSaga</span> <span class="token punctuation">:</span> <span class="token class-name">IVersionedSaga</span><span class="token punctuation">,</span> Resource
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token class-name">JsonProperty</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment">// This overrides the Resource [JsonProperty(&quot;id&quot;)], which exists on the Resource classes Id property. This means Id will be a null guid, so just always use CorrelationId instead</span>
    <span class="token keyword">public</span> <span class="token class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">// The Resource class has the [JsonProperty(&quot;_etag&quot;)] public string ETag {get;set;}, so we don't need to declare it here</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> State <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> SomeProperty <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// And in your bus/saga configuration, just follow the example below, no need to use the GetSagaRenameSettings&lt;&gt;()</span>
</code></pre></div><p>So my preference is option 3, or option 2. Option 1 is there to offer an option as backwards compatibility to existing functionality.</p> <p>Instantiation of the DocumentDb saga repository could be done like this:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> documentDbClient <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">DocumentClient</span><span class="token punctuation">(</span>endpointUri<span class="token punctuation">,</span> authKeyString<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> repository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">DocumentDbSagaRepository</span><span class="token punctuation">&lt;</span><span class="token class-name">SampleSaga</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>documentDbClient<span class="token punctuation">,</span> <span class="token string">&quot;sagaDatabase&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>If you use a container, you can use the code like this (example for Autofac):</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>builder<span class="token punctuation">.</span><span class="token function">RegisterInstance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DocumentClient</span><span class="token punctuation">(</span>endpointUri<span class="token punctuation">,</span> authKeyString<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">As</span><span class="token punctuation">&lt;</span><span class="token class-name">IDocumentClient</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> 
        <span class="token keyword">new</span> <span class="token class-name">DocumentDbSagaRepository</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Resolve</span><span class="token punctuation">&lt;</span><span class="token class-name">IDocumentClient</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;sagaDatabase&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>As<span class="token operator">&lt;</span>ISagaRepository<span class="token operator">&lt;</span>SampleSaga<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">SingleInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="azure-service-bus"><a href="#azure-service-bus" class="header-anchor">#</a> Azure Service Bus</h2> <p>Azure Service Bus provides a feature called <em>message sessions</em>, to process multiple messages at once and to store some state on a temporary basis, which can be retrieved by some key.</p> <p>The latter give us an ability to use this feature as saga state storage. Using message sessions as saga persistence, you can only use Azure Service Bus for both messaging and saga persistence purposes, without needing any additional infrastructure.</p> <p>There is a limitation for using message sessions - this feature is not supported for AMQP transport.</p> <p>You have to explicitly enable message sessions when configuring the endpoint, and use parameterless constructor to instantiate the saga repository.</p> <p>Here is the basic sample of how to use the Azure Service Bus message session as saga repository:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> sagaStateMachine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MySagaStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> repository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">MessageSessionSagaRepository</span><span class="token punctuation">&lt;</span><span class="token class-name">MySaga</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
sbc<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;test_queue&quot;</span><span class="token punctuation">,</span> ep <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    ep<span class="token punctuation">.</span>RequiresSession <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
    ep<span class="token punctuation">.</span><span class="token function">StateMachineSaga</span><span class="token punctuation">(</span>sagaStateMachine<span class="token punctuation">,</span> repository<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>As mentioned before, the message session allows storing and retrieving any state by some unique key. This means that this type of saga persistence only support correlation by id. So, similar to Redis saga persistence, you cannot use <code>CorrelateBy</code> to specify how to find the saga instance, but only <code>CorrelateById</code>.</p> <h2 id="dapper"><a href="#dapper" class="header-anchor">#</a> Dapper</h2> <p>Provides persistence for MSSQL using <a href="https://github.com/StackExchange/Dapper" target="_blank" rel="noopener noreferrer">Dapper<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>Dapper.Contrib is used for inserts and updates. The methods are virtual, so if you'd rather write the SQL yourself it is supported.</p> <p>If you do not write your own sql, the model requires you use the <code>ExplicitKey</code> attribute for the CorrelationId. And if you have properties that are not available as columns, you can use the <code>Computed</code> attribute to not include them in the generated SQL.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SampleSaga</span> <span class="token punctuation">:</span> <span class="token class-name">ISaga</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token class-name">ExplicitKey</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> State <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token class-name">Computed</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> Expression<span class="token operator">&lt;</span>Func<span class="token operator">&lt;</span>SimpleSaga<span class="token punctuation">,</span> ObservableSagaMessage<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token operator">&gt;&gt;</span> CorrelationExpression
    <span class="token punctuation">{</span>
        <span class="token keyword">get</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>saga<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> saga<span class="token punctuation">.</span>Name <span class="token operator">==</span> message<span class="token punctuation">.</span>Name<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="limitations"><a href="#limitations" class="header-anchor">#</a> Limitations</h4> <p>The tablename can only be the pluralized form of the class name. So <code>SampleSaga</code> would translate to table SampleSaga<strong>s</strong>. This applies even if you write your own SQL for updates and inserts.</p> <p>The expressions you can use for correlation is somewhat limited. These types of expressions are handled:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>CorrelationId <span class="token operator">==</span> someGuid<span class="token punctuation">;</span>
    x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>IsDone<span class="token punctuation">;</span>
    x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>CorrelationId <span class="token operator">==</span> someGuid <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>IsDone<span class="token punctuation">;</span>
</code></pre></div><p>You can use multiple <code>&amp;&amp;</code> in the expression.</p> <p>What you can not use is <code>||</code> and negations. So a bool used like this <code>x.IsDone</code> can only be handled as true and nothing else.</p> <p>Dapper does not yet support strong naming, though it is being <a href="https://github.com/StackExchange/Dapper/issues/889" target="_blank" rel="noopener noreferrer">worked<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> on.</p> <p>Also this does not support dotnetcore yet.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/MassTransit/MassTransit/edit/develop/docs/usage/sagas/persistence.md" target="_blank" rel="noopener noreferrer">Help us by improving this page!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/11/2019, 3:58:22 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/MassTransit/usage/sagas/automatonymous.html" class="prev">Automatonymous</a></span> <span class="next"><a href="/MassTransit/usage/containers/msdi.html">Microsoft</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/MassTransit/assets/js/app.35715e6f.js" defer></script><script src="/MassTransit/assets/js/2.d01194ec.js" defer></script><script src="/MassTransit/assets/js/97.b9149593.js" defer></script>
  </body>
</html>
